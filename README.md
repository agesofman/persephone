
<!-- README.md is generated from README.Rmd. Please edit that file -->

# <img src="inst/logo/logo_full.png" height="70px" alt="logo"/>

<!-- badges: start -->
<!-- badges: end -->

This package is part of the `prometheus` family of R packages. It deals
with statistical methodology and applications in crop development.

## Installation

You can install the development version of `cronus` like so:

``` r
 library(devtools)
 install_github(thechibo/persephone)
```

## **Project Structure**

First of all, the project needs to be cloned in your local machine. You
can open the project in RStudio by clicking on the `croplands.Rproj`
file. By default, the working directory is the root of the project.

The project contains the following folders and files:

- src: This directory contains the code of the project (functions,
  classes and methods).

  - data: This directory contains the code required to download data.
  - model: This directory contains the code required to implement a
    model.

- data: This directory contains the data used in the project.

- prm: This directory contains the parameters needed in the execution of
  the src code.

- output: This directory contains the results of the analyses.

- panel: This directory contains the interactive dashboards.

You can load the code stored in the src directory by running the
following lines of code.

``` r
    dir = list.files(file.path(getwd(), "src"), pattern = "*.R$", full.names = TRUE, recursive = TRUE)
    invisible(sapply(dir, source))
```

## **Analysis**

This section covers the model creation and analysis. Model evaluation is
encapsulated in the `report()` function, which generates reports is in
html format, stored in the `output` folder. Interactive model comparison
can be achieved through the panels (dashboards) stored in the `panel`
folder.

### Load the data

You can load the dataset of a US state by executing the following
commands:

``` r
    # data directory
    dir = file.path(getwd(), "data", state, "dataset", crop)

    # Load the data
    data      = read.csv(file.path(dir, "weekly.csv"))[ , -1]
    dailydata = read.csv(file.path(dir,  "daily.csv"))[ , -1]

    # Select the best-performing covariates
    data$AGDD  = data$AGDDfield
    data$APRCP = data$APRCPfield
    data$NDVI  = data$mean_max_29
```

### Create a Model

Model are implemented as objects of classes. Model classes have a tree
structure, a part of which is illustrated below:

- M (Model)

  - LSM (Large Scale Model)

    - RegressionLSM

      - PPOLogisticRegressionLSM
      - SeasonRegressionLSM
      - StageLogisticRegressionLSM
      - WeekRegressionLSM

    - RandomForestLSM

      - StageRandomForestLSM
      - MultivariateRandomForestLSM

  - SSM (Small Scale Model)

Each model class is composed of *slots* and can be generated by a
*generator function*. For example, the StageLogisticRegressionLSM model,
which is created with the function `slrLSM` requires the slots state,
crop and formula.

``` r
    formula = "Week + AGDD + APRCP + NDVI"
    object = slrLSM(state = state, crop = crop, formula = formula)
```

Instead of explicitly typing the slots of a model, it is easier to store
them in the `prm` folder and use the `model()` function. The files are
stored in the location
\~/croplands/prm/model/phenology/largescale/<ClassNameLSM>. The files
may contain some or all the slots required in the creation of a model.
Consider the following example, that reads the formula from the
`multiformula.R` file and gets the other two slots as a list (named
`prm`).

``` r
    prm = list(crop = crop, state = state)
    object = model("StageLogisticRegressionLSM", "multiformula", prm)  
```

### Fit

The model can be fitted on user-supplied data with the function `fit()`.

``` r
    fobject = fit(object, data)
```

You can plot the fitted data with the function `plot()`.

``` r
    plot(x = data,
         y = fobject@fitted,
         stages = stagenames(object@crop),
         season = 2002,
         title = paste0("Fitting for Season ", 2002))
```

### Predict

The fitted model can be used in prediction:

``` r
    tdata = dplyr::filter(data, Year %in% 2002:2013)
    pdata = dplyr::filter(data, Year %in% 2014:2019)
    fobject = fit(object, tdata)
    yhat = predict(fobject, pdata)
    plot(x = pdata,
         y = yhat,
         stages = stagenames(object@crop),
         season = 2014,
         title = paste0("Fitting for Season ", 2014))
```

### Monte-Carlo Cross-Validation

Finally, the `crossval()` function performs Monte-Carlo
cross-validation, splitting the data provided in random train-test sets.

``` r
    cvm = crossval(object, data)
    plot.rmspe(cvm$time, legend = FALSE, title = NULL)
    cvm$stage
```

### Report

All of the above can be printed into an RMarkdown report with the
`report()` function. The reports are stored in the folder
\~/croplands/output/model/phenology/largescale/ClassNameLSM.

``` r
    report(object, data, dailydata, output = "multiformula")
```
